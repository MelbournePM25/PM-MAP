<!DOCTYPE html>
<html lang="en">
<head>
    <title>Google Maps Integration</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
        #filter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            z-index: 1000;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="filter">
        <label for="directorFilter">Filter by Director:</label>
        <select id="directorFilter">
            <option value="all">Show All</option>
        </select>
    </div>
    <div id="map"></div>

    <script>
        let markers = [];
        let map;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: { lat: 43.72023, lng: -79.47168 }
            });

            fetch('https://script.google.com/macros/s/AKfycby04eidti8v5KG25hYlQaAkS_G0Fvz0uIqaHLRf64kEYVfM3V_wng4MRbjEOtdyzDgg/exec')
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched Data:", data);
                    const directorsSet = new Set();

                    data.forEach(property => {
                        let latLngString = property["Latitude/Longitude"] || "";
                        let directorName = property["DIRECTOR"] || "Unknown";
                        directorsSet.add(directorName);

                        if (latLngString.includes(',')) {
                            const latLng = latLngString.split(',').map(coord => parseFloat(coord.trim()));
                            if (!isNaN(latLng[0]) && !isNaN(latLng[1])) {
                                const marker = new google.maps.Marker({
                                    position: { lat: latLng[0], lng: latLng[1] },
                                    map: map,
                                    title: property["Community"],
                                    icon: getDirectorColor(directorName)
                                });

                                const infoWindow = new google.maps.InfoWindow({
                                    content: `<div>
                                                <h3>${property["Community"]}</h3>
                                                <p><strong>Property Manager:</strong> ${property["Property Manager"]}</p>
                                                <p><strong>Phone:</strong> ${property["PM: P#"]}</p>
                                                <p><strong>Director:</strong> ${directorName}</p>
                                              </div>`
                                });

                                marker.addListener('click', () => {
                                    infoWindow.open(map, marker);
                                });

                                markers.push({ marker, director: directorName });
                            }
                        }
                    });

                    populateFilter(directorsSet);
                })
                .catch(error => console.error('Error loading properties:', error));
        }

        function populateFilter(directorsSet) {
            const filter = document.getElementById("directorFilter");
            directorsSet.forEach(director => {
                const option = document.createElement("option");
                option.value = director;
                option.textContent = director;
                filter.appendChild(option);
            });

            filter.addEventListener("change", function() {
                filterMarkers(this.value);
            });
        }

        function filterMarkers(selectedDirector) {
            markers.forEach(({ marker, director }) => {
                if (selectedDirector === "all" || director === selectedDirector) {
                    marker.setMap(map);
                } else {
                    marker.setMap(null);
                }
            });
        }

        function getDirectorColor(director) {
            const colors = {
                'Elena Schneider': 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                'Sophia Khajehnouri': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                'Nathan Browne': 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
                'Darla Ahmeti': 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                'Melody King': 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png',
                'Jessica Gunawardana': 'http://maps.google.com/mapfiles/ms/icons/pink-dot.png',
                'Unknown': 'http://maps.google.com/mapfiles/ms/icons/grey-dot.png'
            };
            return colors[director] || colors['Unknown'];
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmaxpp71HV-Rh94eSohRMc-PLTpWIw_Zc&loading=async&callback=initMap"></script>
</body>
</html>
