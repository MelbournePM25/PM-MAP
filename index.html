<!DOCTYPE html>
<html lang="en">
<head>
    <title>Unified Map of Current & Future Properties</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
        #filters {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            z-index: 1000;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="filters">
        <label for="directorFilter">Filter by Director:</label>
        <select id="directorFilter">
            <option value="all">Show All</option>
        </select>
        <br>
        <label for="managerFilter">Filter by Property Manager:</label>
        <select id="managerFilter">
            <option value="all">Show All</option>
        </select>
        <br>
        <label>
            <input type="checkbox" id="futureToggle" checked>
            Show Future Properties
        </label>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let allMarkers = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: { lat: 43.72023, lng: -79.47168 }
            });

            // Fetch the data from Google Sheets script
            const DATA_URL = 'https://script.google.com/macros/s/AKfycbzGpMK2N83HAuXAB8c4qHNpPF5jh_sCFM8iJnUGqbWOUmwmwx7xAbwvs5qzA2KqBppx/exec';

            fetch(DATA_URL)
            .then(response => response.json())
            .then(data => {
                console.log('Fetched Properties:', data);

                const directorsSet = new Set();
                const managersSet = new Set();

                data.forEach(item => {
                    let latLngString = item["Latitude/Longitude"] || "";
                    let isFuture = item["FUTURE"] && item["FUTURE"].trim().toLowerCase() === "yes";
                    let directorName = item["DIRECTOR"] ? item["DIRECTOR"].trim() : "Unknown";
                    let propertyManager = item["Property Manager"] ? item["Property Manager"].trim() : "Unknown";
                    
                    directorsSet.add(directorName);
                    managersSet.add(propertyManager);

                    if (latLngString.includes(',')) {
                        const latLng = latLngString.split(',').map(coord => parseFloat(coord.trim()));
                        if (!isNaN(latLng[0]) && !isNaN(latLng[1])) {
                            const marker = new google.maps.Marker({
                                position: { lat: latLng[0], lng: latLng[1] },
                                map: map,
                                title: item["Community"] || "Unknown Property",
                                icon: isFuture ? 'http://maps.google.com/mapfiles/ms/icons/ltblue-dot.png' : getDirectorColor(directorName)
                            });

                            const infoWindow = new google.maps.InfoWindow({
                                content: `<div>
                                            <h3>${item["Community"] || "Unknown Property"}</h3>
                                            <p><strong>Property Manager:</strong> ${propertyManager}</p>
                                            <p><strong>Phone:</strong> ${item["PM: P#"] || "N/A"}</p>
                                            <p><strong>Director:</strong> ${directorName}</p>
                                          </div>`
                            });

                            marker.addListener('click', () => {
                                infoWindow.open(map, marker);
                            });

                            allMarkers.push({ marker, director: directorName, manager: propertyManager, isFuture });
                        }
                    }
                });

                populateFilters(directorsSet, managersSet);
                applyFilters(); // Ensure the correct properties are displayed
            })
            .catch(error => console.error('Error loading properties:', error));
        }

        function populateFilters(directorsSet, managersSet) {
            const directorFilter = document.getElementById("directorFilter");
            directorsSet.forEach(director => {
                const option = document.createElement("option");
                option.value = director;
                option.textContent = director;
                directorFilter.appendChild(option);
            });

            const managerFilter = document.getElementById("managerFilter");
            managersSet.forEach(manager => {
                const option = document.createElement("option");
                option.value = manager;
                option.textContent = manager;
                managerFilter.appendChild(option);
            });

            directorFilter.addEventListener("change", applyFilters);
            managerFilter.addEventListener("change", applyFilters);
            document.getElementById("futureToggle").addEventListener("change", applyFilters);
        }

        function applyFilters() {
            const selectedDirector = document.getElementById("directorFilter").value;
            const selectedManager = document.getElementById("managerFilter").value;
            const showFuture = document.getElementById("futureToggle").checked;

            allMarkers.forEach(({ marker, director, manager, isFuture }) => {
                const directorMatch = selectedDirector === "all" || director === selectedDirector;
                const managerMatch = selectedManager === "all" || manager === selectedManager;
                const futureMatch = isFuture ? showFuture : true;

                marker.setMap(directorMatch && managerMatch && futureMatch ? map : null);
            });
        }

        function getDirectorColor(director) {
            const colors = {
                'Elena Schneider': 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                'Sophia Khajehnouri': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                'Nathan Browne': 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
                'Darla Ahmeti': 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                'Melody King': 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png',
                'Jessica Gunawardana': 'http://maps.google.com/mapfiles/ms/icons/pink-dot.png',
                'Unknown': 'http://maps.google.com/mapfiles/ms/icons/orange-dot.png'
            };
            return colors[director] || colors['Unknown'];
        }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmaxpp71HV-Rh94eSohRMc-PLTpWIw_Zc&callback=initMap"
      async
    ></script>
</body>
</html>
